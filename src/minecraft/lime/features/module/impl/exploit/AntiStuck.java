package lime.features.module.impl.exploit;

import lime.core.Lime;
import lime.core.events.EventTarget;
import lime.core.events.impl.EventPacket;
import lime.features.module.Category;
import lime.features.module.Module;
import lime.features.module.ModuleData;
import lime.features.module.impl.movement.Flight;
import lime.features.module.impl.movement.LongJump;
import lime.features.module.impl.movement.Speed;
import lime.utils.other.Timer;
import net.minecraft.init.Blocks;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.util.BlockPos;

@ModuleData(name = "Anti Stuck", category = Category.EXPLOIT)
public class AntiStuck extends Module {

    private final Timer timer = new Timer();

    @Override
    public void onEnable() {
        timer.reset();
    }

    @EventTarget
    public void onPacket(EventPacket e) {
        if(Lime.getInstance().getModuleManager().getModuleC(LongJump.class).isToggled() || Lime.getInstance().getModuleManager().getModuleC(Flight.class).isToggled() || Lime.getInstance().getModuleManager().getModuleC(Speed.class).isToggled())
            return;
        if(inVoid() && e.getPacket() instanceof S08PacketPlayerPosLook && timer.hasReached(15000)) {
            timer.reset();
        }

        if(e.getPacket() instanceof C03PacketPlayer && !timer.hasReached(1000)) {
            e.setCanceled(true);
        }
    }

    public boolean inVoid() {
        for (int i = (int) Math.ceil(mc.thePlayer.posY); i >= 0; --i) {
            if (mc.theWorld.getBlockState(new BlockPos(mc.thePlayer.posX, i, mc.thePlayer.posZ)).getBlock() != Blocks.air) {
                return false;
            }
        }
        return true;
    }
}
