package lime.features.module.impl.exploit;

import lime.bot.impl.Bot;
import lime.bot.mc.protocol.packet.ingame.client.ClientChatPacket;
import lime.bot.mc.protocol.packet.ingame.client.player.ClientPlayerPositionRotationPacket;
import lime.core.events.EventTarget;
import lime.core.events.impl.EventMotion;
import lime.core.events.impl.EventPacket;
import lime.core.events.impl.EventWorldChange;
import lime.features.commands.impl.Account;
import lime.features.module.Category;
import lime.features.module.Module;
import lime.features.setting.impl.EnumValue;
import lime.utils.other.ChatUtils;
import lime.utils.other.MathUtils;
import lime.utils.other.Timer;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S00PacketKeepAlive;
import net.minecraft.network.play.server.S32PacketConfirmTransaction;

public class Disabler extends Module {

    public Disabler() {
        super("Disabler", Category.EXPLOIT);
    }

    private final EnumValue mode = new EnumValue("Mode", this, "Erisium", "Erisium", "Ghostly_Movement", "Verus_Combat", "Mineplex_Combat", "Mineplex");

    private final Timer timer = new Timer();

    private Bot bot;

    @Override
    public void onEnable() {
        bot = null;
    }

    @Override
    public void onDisable() {
        if(bot != null && bot.getClient().getSession().isConnected()) {
            try {
                bot.getClient().getSession().disconnect("");
            } catch (Exception ignored) {}
        }
    }

    @EventTarget
    public void onWorldChange(EventWorldChange e) {
        if(e.getWorld() == null) {
            bot.getClient().getSession().disconnect("");
            bot = null;
        }
    }

    @EventTarget
    public void onPacket(EventPacket e) {
        if(mode.is("erisium")) {
            if(mc.thePlayer != null && mc.theWorld != null) {
                if(e.getPacket() instanceof C0FPacketConfirmTransaction || e.getPacket() instanceof C00PacketKeepAlive || e.getPacket() instanceof S00PacketKeepAlive || e.getPacket() instanceof S32PacketConfirmTransaction) {
                    e.setCanceled(true);
                }
                if(e.getPacket() instanceof C00PacketKeepAlive) {
                    if(timer.hasReached(6000)) {
                        C00PacketKeepAlive packet = (C00PacketKeepAlive) e.getPacket();
                        mc.getNetHandler().sendPacketNoEvent(new C00PacketKeepAlive(packet.getKey()));
                        timer.reset();
                    }
                }

                if(e.getPacket() instanceof C0FPacketConfirmTransaction) {
                    C0FPacketConfirmTransaction packet = (C0FPacketConfirmTransaction) e.getPacket();
                    if(timer.hasReached(6000)) {
                        mc.getNetHandler().sendPacketNoEvent(new C0FPacketConfirmTransaction(packet.getWindowId(), packet.getUid(), packet.accepted));
                        timer.reset();
                    }
                }
            }
        }

        if(mode.is("verus_combat")) {
            if(e.getPacket() instanceof C0FPacketConfirmTransaction || e.getPacket() instanceof C0BPacketEntityAction)
                e.setCanceled(true);
        }

        if(mode.is("mineplex_combat") || mode.is("mineplex")) {
            if(e.getPacket() instanceof C00PacketKeepAlive) {
                C00PacketKeepAlive p = (C00PacketKeepAlive) e.getPacket();
                p.key = (int) MathUtils.random(0, Integer.MAX_VALUE);
                e.setPacket(p);
            }
        }

        if(mode.is("mineplex")) {
            if(e.getPacket() instanceof C03PacketPlayer) {
                if(bot == null) {
                    if(!Account.mail.equals("")) {
                        bot = new Bot(Account.mail, Account.pass);
                        bot.startBot();
                    } else {
                        ChatUtils.sendMessage("Set alt with .spec mail:pass");
                        this.toggle();
                    }
                    return;
                }

                if(bot.getPosition() != null) {
                    double x = mc.thePlayer.posX;
                    double y = mc.thePlayer.posY;
                    double z = mc.thePlayer.posZ;
                    float yaw = mc.thePlayer.rotationYaw;
                    float pitch = mc.thePlayer.rotationPitch;

                    try {
                        bot.getClient().getPacketProtocol().getOutgoingId(ClientPlayerPositionRotationPacket.class);
                        if(mc.thePlayer.ticksExisted % 30 == 0) {
                            bot.getClient().getSession().send(new ClientChatPacket("/spec " + mc.session.getUsername()));
                        }
                        double posX = x - bot.getPosition().getX();
                        double posY = y - bot.getPosition().getY();
                        double posZ = z - bot.getPosition().getZ();
                        double xyz = Math.pow(posX, 2) + Math.pow(posY, 2) + Math.pow(posZ, 2);
                        if(Math.sqrt(xyz) < 40) {
                            bot.setPosition(new Bot.Position(x, y, z));
                            bot.getClient().getSession().send(new ClientPlayerPositionRotationPacket(mc.thePlayer.onGround, x, y, z, yaw, pitch));
                        }
                    } catch (Exception ignored) {}
                }
            }
        }
    }

    @EventTarget
    public void onMotion(EventMotion e) {
        this.setSuffix(mode.getSelected());
        if(e.isPre() && mode.is("ghostly_movement")) {
            mc.getNetHandler().addToSendQueue(new C0CPacketInput());
            mc.getNetHandler().addToSendQueue(new C18PacketSpectate(mc.thePlayer.getUniqueID()));
        }

        if(mode.is("mineplex")) {
            if(bot != null) {
                mc.theWorld.playerEntities.removeIf(player -> player.getName().equals(bot.getUserName()));
            }
        }
    }
}
