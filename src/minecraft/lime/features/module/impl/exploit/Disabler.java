package lime.features.module.impl.exploit;

import lime.core.Lime;
import lime.core.events.EventTarget;
import lime.core.events.Priority;
import lime.core.events.impl.EventMotion;
import lime.core.events.impl.EventPacket;
import lime.core.events.impl.EventUpdate;
import lime.core.events.impl.EventWorldChange;
import lime.features.module.Category;
import lime.features.module.Module;
import lime.features.module.impl.world.Scaffold;
import lime.features.setting.impl.EnumProperty;
import lime.ui.notifications.Notification;
import lime.utils.other.ChatUtils;
import lime.utils.other.PacketSleepThread;
import lime.utils.other.Timer;
import net.minecraft.entity.item.EntityBoat;
import net.minecraft.network.Packet;
import net.minecraft.network.handshake.client.C00Handshake;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.*;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;
import org.apache.commons.lang3.RandomUtils;

import java.util.LinkedList;
import java.util.Queue;

public class Disabler extends Module {

    public Disabler() {
        super("Disabler", Category.EXPLOIT);
    }

    public final EnumProperty mode = new EnumProperty("Mode", this, "Erisium", "Erisium", "Verus", "Kokscraft", "Cubecraft", "Rinaorc", "Ghostly_Movement", "BlocksMC", "Verus Transaction", "Verus_Combat", "Watchdog", "Dev");
    private final EnumProperty bmcMode = new EnumProperty("BlocksMC mode", this, "1", "1", "2").onlyIf(mode.getSettingName(), "enum", "BlocksMC");


    private final Timer timer = new Timer();
    private final Queue<Packet<?>> packetQueue = new LinkedList<>();
    private boolean wait, funny, receivedItems, disabled, b;
    @Override
    public void onEnable() {
        timer.reset();
        wait = true;
        funny = receivedItems = b = disabled = false;
        if(mode.is("blocksmc")) {
            Lime.getInstance().getNotificationManager().getNotifications().removeIf(notification -> notification.getName().contains("Wait") && notification.getName().contains("disabler."));
            Lime.getInstance().getNotificationManager().addNotification("Wait 10 seconds before using the disabler.", 10, Notification.Type.INFORMATION);
        }
        packetQueue.clear();
    }

    @Override
    public void onDisable() {
        packetQueue.clear();
    }

    @EventTarget
    public void onUpdate(EventUpdate e) {
        if(mode.is("rinaorc") || (mode.is("kokscraft") && Lime.getInstance().getModuleManager().getModuleC(Scaffold.class).isToggled())) {
            mc.getNetHandler().sendPacketNoEvent(new C08PacketPlayerBlockPlacement(new BlockPos(0, 0, 0), 1, mc.thePlayer.getCurrentEquippedItem(), 0, 0, 0));
        }

        if(mode.is("cubecraft") || mode.is("kokscraft")) {
            if(timer.hasReached(RandomUtils.nextInt(2400, 7400))) {
                while(!packetQueue.isEmpty()) {
                    mc.getNetHandler().sendPacketNoEvent(packetQueue.poll());
                }
                timer.reset();
            }
        }

        if(mode.is("Verus Transaction")) {
            if(timer.hasReached(18000) && wait) {
                wait = false;
                timer.reset();
                Lime.getInstance().getNotificationManager().addNotification("Disabled.", Notification.Type.SUCCESS);
            }
        }

        if(mode.is("verus")) {
            if(mc.thePlayer.ridingEntity instanceof EntityBoat && !funny) {
                mc.getNetHandler().sendPacketNoEvent(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.DROP_ITEM, BlockPos.ORIGIN, EnumFacing.DOWN));
            }
        }

        if(mode.is("blocksmc")) {
            if(timer.hasReached(10000)) {
                int i = 0;
                while(packetQueue.size() > 44) {
                    ++i;
                    mc.getNetHandler().sendPacketNoEvent(packetQueue.poll());
                }
                wait = false;
                timer.reset();
                ChatUtils.sendMessage("Sent " + i + " packets");
            }
            if(mc.thePlayer.ticksExisted % (mode.is("1") ? 100 : 45) == 0 && !wait) {
                e.setCanceled(true);
                Lime.getInstance().getNotificationManager().addNotification("You can now fly.", 1, Notification.Type.SUCCESS);
                if(bmcMode.is("1")) {
                    mc.getNetHandler().sendPacketNoEvent(new C03PacketPlayer.C04PacketPlayerPosition(mc.thePlayer.posX+100, mc.thePlayer.posY, mc.thePlayer.posZ+100, false));
                } else {
                    mc.getNetHandler().sendPacketNoEvent(new C03PacketPlayer.C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY-11, mc.thePlayer.posZ, false));
                }
            }
        }
    }

    @EventTarget
    public void onWorldChange(EventWorldChange e) {
        packetQueue.clear();
        if(mode.is("blocksmc")) {
            Lime.getInstance().getNotificationManager().getNotifications().removeIf(notification -> notification.getName().contains("Wait") && notification.getName().contains("disabler."));
            Lime.getInstance().getNotificationManager().addNotification("Wait 10 seconds before using the disabler.", 10, Notification.Type.INFORMATION);
        }
        wait = true;
        funny = receivedItems = b = disabled = false;
        timer.reset();
    }

    @EventTarget
    public void onPacket(EventPacket e) {
        if (mode.is("Verus Transaction")) {
            if (e.getPacket() instanceof C0FPacketConfirmTransaction) {
                new PacketSleepThread(e.getPacket(), 18000).start();
                e.setCanceled(true);
            }
        }

        if ((mode.is("cubecraft") || mode.is("kokscraft")) && e.getPacket() instanceof C0FPacketConfirmTransaction) {
            packetQueue.add(e.getPacket());
            e.setCanceled(true);
        }

        if (mode.is("blocksmc")) {
            if(e.getPacket() instanceof C03PacketPlayer && mc.thePlayer.ticksExisted % 3 == 0 && !wait) {
                e.setCanceled(true);
            }
            if (e.getPacket() instanceof C0FPacketConfirmTransaction && mc.thePlayer.ticksExisted > 3) {
                packetQueue.add(e.getPacket());
                e.setCanceled(true);
            }
            if (e.getPacket() instanceof S08PacketPlayerPosLook && !wait) {
                S08PacketPlayerPosLook s = (S08PacketPlayerPosLook) e.getPacket();
                double x = s.getX() - mc.thePlayer.posX;
                double y = s.getY() - mc.thePlayer.posY;
                double z = s.getZ() - mc.thePlayer.posZ;
                if (Math.sqrt(x * x + y * y + z * z) < 8) {
                    mc.getNetHandler().sendPacketNoEvent(new C03PacketPlayer.C06PacketPlayerPosLook(s.getX(), s.getY(), s.getZ(), s.getYaw(), s.getPitch(), true));
                    e.setCanceled(true);
                }
            }
            if (e.getPacket() instanceof C0BPacketEntityAction) {
                e.setCanceled(true);
            }
        }

        if(mode.is("verus")) {
            if(e.getPacket() instanceof C03PacketPlayer && receivedItems) {
                if(disabled) {
                    C03PacketPlayer p = (C03PacketPlayer) e.getPacket();
                    p.onGround = false;
                    e.setPacket(p);
                }
                if(mc.thePlayer.ridingEntity != null) {
                    mc.thePlayer.swingItem();
                    mc.getNetHandler().sendPacketNoEvent(new C02PacketUseEntity(mc.thePlayer.ridingEntity, C02PacketUseEntity.Action.ATTACK));
                    b = true;
                }

                if(mc.thePlayer.ridingEntity == null && b) {
                    funny = true;
                }
            }

            if(e.getPacket() instanceof S13PacketDestroyEntities) {
                S13PacketDestroyEntities p = (S13PacketDestroyEntities) e.getPacket();
                boolean boat = false;
                for (int entityID : p.getEntityIDs()) {
                    if(mc.theWorld.getEntityByID(entityID) instanceof EntityBoat) {
                        boat = true;
                    }
                }

                if(boat && p.getEntityIDs().length > 1) {
                    Lime.getInstance().getNotificationManager().addNotification("Disabled.", Notification.Type.SUCCESS);
                    disabled = true;
                }
            }
            if(e.getPacket() instanceof S0DPacketCollectItem) {
                if(((S0DPacketCollectItem) e.getPacket()).getEntityID() == mc.thePlayer.getEntityId()) {
                    receivedItems = true;
                }
            }
        }

        if(mode.is("watchdog")) {
            if(e.getPacket() instanceof C0FPacketConfirmTransaction) {
                e.setCanceled(true);
                packetQueue.add(e.getPacket());
            }

            if(timer.hasReached(1000)) {
                for (Packet<?> packet : packetQueue) {
                    mc.getNetHandler().sendPacketNoEvent(packet);
                }
                ChatUtils.sendMessage("packet");
                packetQueue.clear();
                timer.reset();
            }
        }

        if (mode.is("erisium")) {
            if (mc.thePlayer != null && mc.theWorld != null) {
                if(e.getPacket() instanceof C0FPacketConfirmTransaction && !timer.hasReached(10000)) {
                    e.setCanceled(true);
                }
            }
        }

        if (mode.is("verus_combat")) {
            if (e.getPacket() instanceof C0FPacketConfirmTransaction || e.getPacket() instanceof C0BPacketEntityAction)
                e.setCanceled(true);
        }
    }

    @EventTarget(priority = Priority.LOW)
    public void onMotion(EventMotion e) {
        this.setSuffix(mode.getSelected());
        if(e.isPre() && mode.is("ghostly_movement")) {
            mc.getNetHandler().addToSendQueue(new C0CPacketInput());
            mc.getNetHandler().addToSendQueue(new C18PacketSpectate(mc.thePlayer.getUniqueID()));
        }
    }
}
